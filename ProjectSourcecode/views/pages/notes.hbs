<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Your Notes</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .card:hover {
            transform: translateY(-5px);
            transition: transform 0.2s;
        }
        .card-text {
            max-height: 60px;
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: monospace;
        }
        .latex-preview {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        .latex-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, white);
        }
    </style>
</head>
<body>

<div class="container mt-5 bg1">
    <h1 class="mb-4">Your Notes</h1>

    {{#if notes.length}}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {{#each notes}}
        <div class="col">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{safeLatex this.title}}</h5>
                    {{#if this.content}}
                    <p class="card-text small text-muted">
                        {{truncateLatex this.content 100}}
                    </p>
                    {{/if}}
                    <div class="mt-auto">
                        <a href="/edit-note/{{this.id}}" class="btn btn-secondary btn-sm me-2">View/Edit</a>
                        <button class="btn btn-primary btn-sm share-note-btn" data-note-id="{{this.id}}">Share</button>
                        <button class="btn btn-danger btn-sm delete-note-btn" data-note-id="{{this.id}}">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <p>You have no saved notes. <a href="/editor">Create a new note</a>.</p>
    {{/if}}

    <!-- Friends' Notes Section -->
    <h2 class="mt-5">Friends' Notes</h2>
    {{#if friendsNotes.length}}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {{#each friendsNotes}}
        <div class="col">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{safeLatex this.title}}</h5>
                    {{#if this.content}}
                    <p class="card-text small text-muted">
                        {{truncateLatex this.content 100}}
                    </p>
                    {{/if}}
                    <p class="card-text text-muted">Shared by: {{this.username}}</p>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <p>Your friends have not shared any notes yet.</p>
    {{/if}}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Delete Note</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this note?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let noteIdToDelete = null;

        // Delete Note Handler
        document.querySelectorAll('.delete-note-btn').forEach(button => {
            button.addEventListener('click', function() {
                noteIdToDelete = this.dataset.noteId;
                $('#deleteConfirmationModal').modal('show');
            });
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (noteIdToDelete) {
                fetch(`/delete-note/${noteIdToDelete}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        const noteCard = document.querySelector(`.delete-note-btn[data-note-id='${noteIdToDelete}']`).closest('.col');
                        noteCard.remove();
                        $('#deleteConfirmationModal').modal('hide');
                        noteIdToDelete = null;
                    } else {
                        alert('Failed to delete note.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting note:', error);
                    alert('An error occurred.');
                });
            }
        });

        // Share Note Handler
        document.querySelectorAll('.share-note-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const noteId = this.dataset.noteId;

                try {
                    // Fetch friends list
                    const friendsResponse = await fetch('/get-friends-for-sharing');
                    const friends = await friendsResponse.json();

                    // Generate modal content
                    const modalHtml = `
                        <div class="modal fade" id="shareModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Share Note</h5>
                                        <button type="button" class="btn-close" data-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="shareForm">
                                            <label for="shareWith" class="form-label">Select Friend to Share With:</label>
                                            <select id="shareWith" class="form-select" required>
                                                <option value="">Select a friend</option>
                                                ${friends.map(friend => 
                                                    `<option value="${friend.friend_username}">${friend.friend_username}</option>`
                                                ).join('')}
                                            </select>
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="canEdit">
                                                <label class="form-check-label" for="canEdit">Allow editing</label>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <!-- Change 'data-bs-dismiss' to 'data-dismiss' -->
                                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                         <button type="button" class="btn btn-primary" id="confirmShare">Share</button>
                                 </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Insert modal into the DOM
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
                    shareModal.show();

                    // Share action
                    document.getElementById('confirmShare').addEventListener('click', async () => {
                        const shareWith = document.getElementById('shareWith').value;
                        const canEdit = document.getElementById('canEdit').checked;

                        if (!shareWith) {
                            alert('Please select a friend to share with.');
                            return;
                        }

                        try {
                            const shareResponse = await fetch('/share-note', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    noteId: noteId,
                                    shareWith: shareWith,
                                    canEdit: canEdit,
                                })
                            });

                            if (shareResponse.ok) {
                                alert('Note shared successfully!');
                                shareModal.hide();
                                document.getElementById('shareModal').remove();
                            } else {
                                throw new Error('Failed to share note');
                            }
                        } catch (error) {
                            alert('Error sharing note: ' + error.message);
                        }
                    });

                    // Cleanup modal when hidden
                    document.getElementById('shareModal').addEventListener('hidden.bs.modal', function () {
                        this.remove();
                    });

                } catch (error) {
                    alert('Error fetching friends: ' + error.message);
                }
            });
        });
    });
</script>

</body>
</html>
