<!-- jQuery and jQuery UI (for resizable feature) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">


<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
.latex-editor-container {
  display: flex;
  flex-direction: row;
  height: 100vh;
  padding: 20px;
  gap: 20px;
  background-color: #f5f5f5;
  box-sizing: border-box;
}

.editor-header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.editor-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 0;
}

.editor-buttons {
  display: flex;
  gap: 5px;
  align-items: center;
}

#note-title {
  margin-bottom: 10px;
  padding: 8px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.preview-header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 10 10 10px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 15px;
  height: 40px;
}

.preview-header-left {
  font-size: 18px;
  font-weight: bold;
}

.preview-header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.preview-action-btn {
  padding: 6px 12px;
  background: none;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  color: #666;
  transition: all 0.2s ease;
}

.preview-action-btn:hover {
  background-color: #f5f5f5;
  color: #4a90e2;
  border-color: #4a90e2;
}

.preview-action-btn .btn-text {
  font-size: 0.85rem;
  font-weight: 500;
}

.preview-action-btn[title]:hover:after {
  content: attr(title);
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
}

.preview-action-btn {
  position: relative;
}

.ai-edit-btn {
  padding: 8px 16px;
  background-color: #6c757d;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.ai-edit-btn.active {
  background-color: #28a745;
}

body {
    font-family: 'Roboto', sans-serif;
  }

.load-notes-container {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
}

.editor {
  width: 50%;
  display: flex;
  flex-direction: column;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #fff;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* custom CodeMirror */
.CodeMirror {
  flex: 1;
  height: 100%;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.preview-container {
  width: 50%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px 15px 15px 15px;
  background-color: #fff;
  overflow-y: auto;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}



@media (max-width: 768px) {
  .latex-editor-container {
    flex-direction: column;
  }
  .editor, .preview-container {
    width: 100%;
  }
}

.modal-content {
  border-radius: 8px;
  box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
}

.modal-header {
  border-bottom: 2px solid #e9ecef;
}

.selected-content {
  max-height: 150px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
  background-color: #f8f9fa;
  white-space: pre-wrap;
}

.instruction-list {
  padding-left: 20px;
  color: #666;
}

.instruction-list li {
  margin-bottom: 8px;
}

.context-input-container {
  background-color: #fff;
  border-radius: 6px;
}

#contextInput {
  border: 1px solid #ced4da;
  border-radius: 6px;
  resize: vertical;
  font-size: 0.95em;
}

#contextInput:focus {
  border-color: #80bdff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.modal-footer {
  border-top: 2px solid #e9ecef;
}

#submitContext {
  padding-left: 1.5rem;
  padding-right: 1.5rem;
}

#submitContext i {
  margin-right: 8px;
}

.highlighted-selection {
  background-color: rgba(144, 238, 144, 0.3); /* Soft lime green */
  transition: background-color 0.3s ease;
}

.selection-alert {
  background-color: #e8f5e9;
  border-left: 4px solid #4caf50;
  padding: 12px;
  margin-bottom: 20px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.selection-alert i {
  color: #4caf50;
  font-size: 1.2em;
}

#contextModal .modal-dialog {
  position: absolute;
  margin: 0;
  top: 50%;
  left: 20px; 
  transform: translateY(-50%);
  width: calc(50% - 40px); 
  max-width: none;
}


.preview-highlight {
  background-color: rgba(144, 238, 144, 0.3);
  transition: background-color 0.3s ease;
}

.notification {
    position: fixed;
    left: 50%;
    top: 20px;
    transform: translateX(-50%);
    padding: 15px 25px;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 1000;
    min-width: 300px;
    text-align: center;
}

.notification.show {
    opacity: 1;
    z-index: 1500;
}

.notification.hide {
    opacity: 0;
    z-index: -1;
}

</style>
<div id="notification" class="notification"></div>
<div class="latex-editor-container">
  <div class="editor">
    <div class="editor-header-container">
        <div class="editor-header">LaTeX Editor</div>
        <div class="editor-buttons">
        <div class="dropdown">
            <button
            id="load-notes-btn"
            class="btn btn-secondary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            >
            Load Notes
            </button>
            <ul id="notes-dropdown" class="dropdown-menu" aria-labelledby="load-notes-btn">
              <!-- populated via JS/API -->
            </ul>
        </div>
        <div class="dropdown">
          <button 
            id="new-note-btn" 
            class="btn btn-success dropdown-toggle" 
            type="button" 
            data-bs-toggle="dropdown" 
            aria-expanded="false"
          >
            New Note
          </button>
          <ul class="dropdown-menu" aria-labelledby="new-note-btn">
            <li><a class="dropdown-item" href="#" id="new-blank">
              <i class="fas fa-file"></i>
              <span>From Blank</span>
            </a></li>
            <li><a class="dropdown-item" href="#" id="new-from-text">
              <i class="fas fa-font"></i>
              <span>From Text</span>
            </a></li>
            <li><a class="dropdown-item" href="/scan" id="new-from-photo">
              <i class="fas fa-camera"></i>
              <span>From Photo</span>
            </a></li>
          </ul>
        </div>
        <!-- Save LaTeX Button -->
        <button id="save-latex" type="button" class="btn btn-primary">Save LaTeX</button>
        </div>
    </div>

    <!-- Title Input -->
    <input type="text" id="note-title" placeholder="Enter note title here" />

    <!-- LaTeX Textarea -->
    <textarea id="latex-editor"></textarea>
  </div>

  <!-- Preview Section -->
  <div class="preview-container">
    <div class="preview-header-container">
      <div class="preview-header-left">Preview</div>
      <div class="preview-header-actions">
        <button class="preview-action-btn" id="download-preview" title="Download">
          <i class="fas fa-download"></i>
        </button>
        <button class="preview-action-btn" id="save-as-template" title="Save as Template">
          <i class="fas fa-save"></i>
          <span class="btn-text">Template</span>
        </button>
        <button class="preview-action-btn" id="share-preview" title="Share">
          <i class="fas fa-share-alt"></i>
        </button>
        <button class="ai-edit-btn" id="ai-edit-btn">
          Highlight text for AI editing
        </button>
      </div>
    </div>
    <div id="latex-preview" class="preview">
      <!-- Rendered HTML here -->
    </div>
  </div>
</div>

<div class="modal fade" id="contextModal" tabindex="-1" aria-labelledby="contextModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="contextModalLabel">AI LaTeX Editor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="selection-alert">
          <i class="fas fa-check-circle"></i>
          <span>Your selection is highlighted in the preview panel</span>
        </div>

        <div class="instruction-container mb-4">
          <h6 class="fw-bold"><i class="fas fa-info-circle text-primary"></i> How this works:</h6>
          <ol class="instruction-list">
            <li>Your selected content is highlighted in the preview panel</li>
            <li>Describe what changes you'd like to make to this LaTeX content</li>
            <li>The AI will suggest improvements to your LaTeX code</li>
          </ol>
        </div>

        <div class="context-input-container">
          <label for="contextInput" class="form-label fw-bold">
            What changes would you like to make?
          </label>
          <textarea 
            id="contextInput" 
            class="form-control" 
            rows="4" 
            placeholder="Example: 'Fix the equation formatting', 'Add proper citations', 'Convert this to a table'..."
          ></textarea>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="submitContext" class="btn btn-primary">
          <i class="fas fa-magic"></i> Generate Changes
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="textToLatexModal" tabindex="-1" aria-labelledby="textToLatexModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="textToLatexModalLabel">Convert Text to LaTeX</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          Paste your text below and our AI will convert it to LaTeX format. Works best with mathematical and scientific text!
        </div>

        <div class="mb-3">
          <label for="textInput" class="form-label fw-bold">Your Text</label>
          <textarea 
            id="textInput" 
            class="form-control" 
            rows="10" 
            placeholder="Paste your text here..."
          ></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Additional Instructions (Optional)</label>
          <textarea 
            id="textInstructions" 
            class="form-control" 
            rows="2" 
            placeholder="Any specific formatting preferences or instructions..."
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="convertToLatex" class="btn btn-primary">
          <i class="fas fa-magic me-2"></i>Convert to LaTeX
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="saveTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save as Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="templateTitle" class="form-label">Template Title</label>
                    <input type="text" class="form-control" id="templateTitle" required>
                </div>
                <div class="mb-3">
                    <label for="templateCategory" class="form-label">Category</label>
                    <select class="form-select" id="templateCategory">
                        <option value="Academic">Academic</option>
                        <option value="Scientific">Scientific</option>
                        <option value="Professional">Professional</option>
                        <option value="Presentation">Presentation</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveTemplate">Save Template</button>
            </div>
        </div>
    </div>
</div>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<!-- CodeMirror LaTeX Mode -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/stex/stex.min.js"></script>
<!-- CodeMirror Addons (e.g., line numbers, bracket matching) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
<!-- LaTeX.js -->
<script src="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.js"></script>

{{#if note}}
  <script> // when loading note from elsewhere
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for CodeMirror to be initialized
      setTimeout(() => {
        const titleInput = document.getElementById('note-title');
        const content = unescapeLatex(`{{{note.content}}}`); // Note the triple brackets
        
        titleInput.value = unescapeLatex(`{{{note.title}}}`); // Note the triple brackets
        editor.setValue(content); // Force a refresh of the editor
        editor.refresh();// Trigger a re-render of the preview
        renderLaTeX();
      }, 100);
    });
  </script>
{{/if}}

<!-- jQuery UI for resizable functionality -->
<script>
  function unescapeLatex(text) { // this function is critical; add any typical latex errors from passing thru api here
    if (!text) return '';
    return text
      .replace(/\\'/g, "'")    // Unescape single quotes
      .replace(/\\"/g, '"')    // Unescape double quotes
      .replace(/\\\\/g, '\\')  // Handle escaped backslashes
      .replace(/&quot;/g, '"') // Handle HTML entities
      .replace(/&#x27;/g, "'") // Handle hex encoded single quotes
      .replace(/&#027;/g, "'") // Handle octal encoded single quotes
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/left\\{1,2}/g, "left")    
      .replace(/right\\{1,2}/g, "right") 
      .replace(/''|&#x27;&#x27;|&#027;&#027;/g, "''");

  }

  $(function() {
    // Make the editor resizable
    $(".editor").resizable({
      handles: 'e', // Resizable from the (right side)
      resize: function(event, ui) {
        // Adjust the width of the preview container as the editor is resized
        let containerWidth = $(".latex-editor-container").width();
        let editorWidth = ui.size.width;
        $(".preview-container").width(containerWidth - editorWidth - 20); // Adjust preview width dynamically
      }
    });
  });

  // Initialize 
  const editor = CodeMirror.fromTextArea(document.getElementById('latex-editor'), {
    mode: 'stex',
    theme: 'monokai', 
    lineNumbers: true,
    lineWrapping: true,
    autoCloseBrackets: true,
    matchBrackets: true,
  });

  // Function to debounce rapid function calls !critical
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Function to render LaTeX to HTML
  function renderLaTeX() {
    const latexContent = editor.getValue();
    const preview = document.getElementById('latex-preview');
    preview.innerHTML = '';
    try {
      // Initialize LaTeX.js generator
      const generator = new latexjs.HtmlGenerator({
        hyphenate: false,
      });

      // Parse LaTeX content
      const documentObj = latexjs.parse(latexContent, { generator: generator });
      // Append styles and scripts
      preview.appendChild(generator.stylesAndScripts("https://cdn.jsdelivr.net/npm/latex.js/dist/"));
      // Append the rendered LaTeX
      preview.appendChild(generator.domFragment());
    } catch (error) {
      preview.innerHTML = `<pre style="color: red;">${error.message}</pre>`;
    }
  }

  // Debounced to prevent excessive rendering
  const debouncedRender = debounce(renderLaTeX, 500);

  renderLaTeX();

  //event listener for changes in the editor
  editor.on('change', debouncedRender);

document.getElementById('save-latex').addEventListener('click', async () => {
  const latexContent = editor.getValue();
  const titleInput = document.getElementById('note-title');
  const title = titleInput.value.trim();

  if (!title) {
    showNotification('Please enter a title for your note.');
    titleInput.focus();
    return;
  }

  try {
    const response = await fetch('/save-latex', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        title,
        content: latexContent,
        category: 'LaTeX',
        username: '{{user.username}}',
      }),
    });

    if (response.ok) {
      showNotification('LaTeX content saved successfully!');
    } else {
      showNotification('Error saving LaTeX content');
    }
  } catch (error) {
    showNotification('Error occurred: ' + error.message);
  }
});

// Function to fetch and display user's notes in the dropdown
document.getElementById('load-notes-btn').addEventListener('click', async () => {
  try {
    const response = await fetch('/get-notes', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (response.ok) {
      const notes = await response.json();
      const dropdownMenu = document.getElementById('notes-dropdown');
      dropdownMenu.innerHTML = ''; // Clear old list items

      notes.forEach((note) => {
        const listItem = document.createElement('li');
        const linkItem = document.createElement('a');
        linkItem.classList.add('dropdown-item');
        linkItem.href = '#';
        linkItem.dataset.noteId = note.id; // Store the note's ID
        linkItem.textContent = note.title;
        listItem.appendChild(linkItem);
        dropdownMenu.appendChild(listItem);
      });
    } else {
      showNotification('Error fetching notes');
    }
  } catch (error) {
    showNotification('Error occurred: ' + error.message);
  }
});


// Function to load selected note into the editor
// Event delegation for dropdown items
document.getElementById('notes-dropdown').addEventListener('click', async function (event) {
  event.preventDefault();
  const target = event.target;
  if (target.classList.contains('dropdown-item')) {
    const noteId = target.dataset.noteId;

    try {
      const response = await fetch(`/get-note/${noteId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        const note = await response.json();
        const unescapedContent = unescapeLatex(note.content);
        
        editor.setValue(unescapedContent); // Set unescaped content
        document.getElementById('note-title').value = unescapeLatex(note.title);
        renderLaTeX();

        // Hide the dropdown menu after selection
        $('.dropdown-toggle').dropdown('hide');
      } else {
        showNotification('Error loading note');
      }
    } catch (error) {
      showNotification('Error occurred: ' + error.message);
    }
  }
});

document.getElementById('new-blank').addEventListener('click', () => {
  // Clear the title input
  document.getElementById('note-title').value = '';
  // Clear the editor content
  editor.setValue('');
  // re-render the preview
  renderLaTeX();
});

document.getElementById('new-from-text').addEventListener('click', () => {
  const textToLatexModal = new bootstrap.Modal(document.getElementById('textToLatexModal'));
  textToLatexModal.show();
});




const preview = document.getElementById('latex-preview');

  // Function to get the selected HTML within the preview
function getSelectedHtml() {
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    // Check if the selection is within the preview area
    if (preview.contains(selection.anchorNode) && preview.contains(selection.focusNode)) {
      const range = selection.getRangeAt(0);
      const container = document.createElement('div');
      container.appendChild(range.cloneContents());
      return container.innerHTML;
    }
  }
  return '';
}


  // needed for storing the selected HTML
  let storedSelectedHtml = '';

  const aiEditBtn = document.getElementById('ai-edit-btn');
  let isTextSelected = false;

  let highlightedRange = null;

  function clearHighlight() {
    const highlights = preview.querySelectorAll('.preview-highlight');
    highlights.forEach(highlight => {
      const parent = highlight.parentNode;
      parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
      parent.normalize(); // Merge adjacent text nodes
    });
    highlightedRange = null;
  }

  function highlightSelection(range) {
    clearHighlight(); // Clear any existing highlights
    const fragment = range.cloneContents();
    const wrapper = document.createElement('span');
    wrapper.classList.add('preview-highlight');
    wrapper.appendChild(fragment);
    
    range.deleteContents();
    range.insertNode(wrapper);
    
    // Store the range for later reference
    highlightedRange = range;
    
    // Clear the user's selection
    window.getSelection().removeAllRanges();
  }

  function onSelectionChange() {
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    
    if (selectedText && preview.contains(selection.anchorNode) && preview.contains(selection.focusNode)) {
      if (!isTextSelected) {
        aiEditBtn.textContent = 'Edit w/ AI';
        aiEditBtn.classList.add('active');
        isTextSelected = true;
        storedSelectedHtml = getSelectedHtml();
        
        // Highlight the selection
        highlightSelection(selection.getRangeAt(0));
      }
    } else {
      if (!highlightedRange) { // Only reset if we're not maintaining a highlight
        if (isTextSelected) {
          aiEditBtn.textContent = 'Highlight text for AI editing';
          aiEditBtn.classList.remove('active');
          isTextSelected = false;
          storedSelectedHtml = '';
        }
      }
    }
  }

  // Add event listeners for selection changes
  preview.addEventListener('mouseup', onSelectionChange);
  preview.addEventListener('keyup', onSelectionChange);

  aiEditBtn.addEventListener('click', () => {
    if (isTextSelected) {
      const contextModal = new bootstrap.Modal(document.getElementById('contextModal'));
      contextModal.show();
    }
  });

  // Add handlers for download and share buttons
  document.getElementById('download-preview').addEventListener('click', () => {
    const latexContent = editor.getValue();
    const titleInput = document.getElementById('note-title');
    let fileName = titleInput.value.trim();
    
    // If no title is set, use a default name
    if (!fileName) {
      fileName = 'untitled';
    }
    
    // Ensure the file has a .tex extension
    if (!fileName.endsWith('.tex')) {
      fileName += '.tex';
    }
    
    // Create a Blob containing the LaTeX content
    const blob = new Blob([latexContent], { type: 'text/plain' });
    // Create a temporary URL for the Blob
    const url = window.URL.createObjectURL(blob);
    // Create a temporary link element
    const downloadLink = document.createElement('a');
    downloadLink.href = url;
    downloadLink.download = fileName;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    
    // Clean up
    document.body.removeChild(downloadLink);
    window.URL.revokeObjectURL(url);
  });

  document.getElementById('share-preview').addEventListener('click', async () => {
    // First save the current note
    const latexContent = editor.getValue();
    const titleInput = document.getElementById('note-title');
    const title = titleInput.value.trim();

    if (!title) {
      showNotification('Please enter a title before sharing.');
      titleInput.focus();
      return;
    }

    try {
      // Save the note first
      const saveResponse = await fetch('/save-latex', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title,
          content: latexContent,
          category: 'LaTeX',
          username: '{{user.username}}',
        }),
      });

      if (!saveResponse.ok) {
        throw new Error('Failed to save note');
      }

      // Fetch friends list
      const friendsResponse = await fetch('/get-friends-for-sharing');
      const friends = await friendsResponse.json();
      //console.log(friends);

      // Create and show the sharing modal
      const modalHtml = `
        <div class="modal fade" id="shareModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Share Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="shareForm">
                  <div class="mb-3">
                    <label class="form-label">Share with:</label>
                    <select class="form-select" id="shareWith" required>
                      <option value="">Select a friend</option>
                      ${friends.map(friend => 
                        `<option value="${friend.friend_username}">${friend.friend_username}</option>`
                      ).join('')}
                    </select>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="canEdit">
                    <label class="form-check-label" for="canEdit">Allow editing</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmShare">Share</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add modal to document
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
      shareModal.show();

      // Handle share confirmation
      document.getElementById('confirmShare').addEventListener('click', async () => {
        const shareWith = document.getElementById('shareWith').value;
        const canEdit = document.getElementById('canEdit').checked;

        if (!shareWith) {
          showNotification('Please select a friend to share with.');
          return;
        }

        try {
          // Get the note ID from the save response
          const saveResponse = await fetch('/save-latex', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title,
              content: latexContent,
              category: 'LaTeX',
              username: '{{user.username}}',
            }),
          });

          const saveData = await saveResponse.json();
          if (!saveData.success) {
            throw new Error('Failed to save note');
          }

          const shareResponse = await fetch('/share-note', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              noteId: saveData.noteId,
              shareWith,
              canEdit,
            }),
          });

          if (shareResponse.ok) {
            showNotification('Note shared successfully!');
            shareModal.hide();
          } else {
            throw new Error('Failed to share note');
          }
        } catch (error) {
          showNotification('Error sharing note: ' + error.message);
        }
      });

      // Clean up modal when hidden
      document.getElementById('shareModal').addEventListener('hidden.bs.modal', function () {
        cleanupModal('shareModal');
        this.remove();
      });

    } catch (error) {
      showNotification('Error: ' + error.message);
    }
  });
  // Event handler for the context modal submission 
  document.getElementById('submitContext').addEventListener('click', async () => {
    const latexSource = editor.getValue();
    const context = document.getElementById('contextInput').value.trim();

    // Prepare the data to be sent to the LLM
    const data = {
      selectedHtml: storedSelectedHtml,
      latexSource: latexSource,
      context: context,
    };

    try {
      const response = await fetch('/process-selection', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        const result = await response.json();
        const updatedLatex = result.updatedLatex;
        editor.setValue(updatedLatex);
        renderLaTeX();
      } else {
        showNotification('Error processing your request.');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('An error occurred while processing your request.');
    }

    // Clean up
    clearHighlight();
    
    // Hide modal
    const contextModal = bootstrap.Modal.getInstance(document.getElementById('contextModal'));
    contextModal.hide();
    
    // Reset states
    document.getElementById('contextInput').value = '';
    aiEditBtn.textContent = 'Highlight text for AI editing';
    aiEditBtn.classList.remove('active');
    isTextSelected = false;
  });

  // Update the modal hide handler
  document.getElementById('contextModal').addEventListener('hidden.bs.modal', function () {
    clearHighlight();
    document.getElementById('contextInput').value = '';
    
    // Reset button state
    aiEditBtn.textContent = 'Highlight text for AI editing';
    aiEditBtn.classList.remove('active');
    isTextSelected = false;
    
    // Re-render the preview
    renderLaTeX();
  });

  document.getElementById('convertToLatex').addEventListener('click', async () => {
    const textInput = document.getElementById('textInput').value.trim();
    const instructions = document.getElementById('textInstructions').value.trim();
    
    if (!textInput) {
      showNotification('Please enter some text to convert.');
      return;
    }
    
    const convertBtn = document.getElementById('convertToLatex');
    const originalBtnHtml = convertBtn.innerHTML;
    convertBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Converting...';
    convertBtn.disabled = true;
    
    try {
      const response = await fetch('/rewrite-text', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: textInput,
          instructions: instructions
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to convert text');
      }

      const result = await response.json();
      
      // Update the editor with the converted LaTeX
      editor.setValue(result.updatedLatex);
      
      // Update the title if none exists
      const titleInput = document.getElementById('note-title');
      if (!titleInput.value.trim()) {
        titleInput.value = 'Converted Text ' + new Date().toLocaleDateString();
      }
      
      // Render the preview
      renderLaTeX();
      
      // Close the modal
      const textToLatexModal = bootstrap.Modal.getInstance(document.getElementById('textToLatexModal'));
      textToLatexModal.hide();
      
    } catch (error) {
      console.error('Error:', error);
      showNotification('Error converting text: ' + error.message);
    } finally {
      // Reset button state
      convertBtn.innerHTML = originalBtnHtml;
      convertBtn.disabled = false;
    }
  });

  // Add modal cleanup on hide
  document.getElementById('textToLatexModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('textInput').value = '';
    document.getElementById('textInstructions').value = '';
  });

//ADDED BELOW TO DEBUG DROPDOWN BUTTON
// Manually initialize the Bootstrap dropdowns
document.addEventListener('DOMContentLoaded', function() {
    var loadNotesBtn = new bootstrap.Dropdown(document.getElementById('load-notes-btn'));
    var newNoteBtn = new bootstrap.Dropdown(document.getElementById('new-note-btn'));

    // Add event listeners to manually toggle the dropdowns on click
    document.getElementById('load-notes-btn').addEventListener('click', function() {
      loadNotesBtn.toggle();
    });
    document.getElementById('new-note-btn').addEventListener('click', function() {
      newNoteBtn.toggle();
    });
  });

document.addEventListener('DOMContentLoaded', function() {
  // Initialize all modals
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    new bootstrap.Modal(modal);
  });

  // Update text-to-latex modal trigger
  document.getElementById('new-from-text').addEventListener('click', function(e) {
    e.preventDefault();
    const modal = new bootstrap.Modal(document.getElementById('textToLatexModal'));
    modal.show();
  });

  // Update AI edit modal trigger
  document.getElementById('ai-edit-btn').addEventListener('click', function() {
    if (isTextSelected) {
      const modal = new bootstrap.Modal(document.getElementById('contextModal'));
      modal.show();
    }
  });

  // Check if we're loading a template
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('template') === 'true') {
    const templateContent = sessionStorage.getItem('template_content');
    const templateTitle = sessionStorage.getItem('template_title');
    
    if (templateContent) {
      // Unescape the content before setting it in the editor
      const unescapedContent = unescapeLatex(templateContent);
      
      // Set the editor content
      editor.setValue(unescapedContent);
      
      // Set the title if provided
      if (templateTitle) {
        document.getElementById('note-title').value = templateTitle;
      }
      
      // Render the preview
      renderLaTeX();
      
      // Clear the template from sessionStorage
      sessionStorage.removeItem('template_content');
      sessionStorage.removeItem('template_title');
    }
  }
});

// Add this function near the top of your script
function cleanupModal(modalId) {
  const modal = document.getElementById(modalId);
  const modalInstance = bootstrap.Modal.getInstance(modal);
  if (modalInstance) {
    modalInstance.dispose();
  }
  // Remove backdrop if it exists
  const backdrop = document.querySelector('.modal-backdrop');
  if (backdrop) {
    backdrop.remove();
  }
  // Remove modal-open class from body
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.paddingRight = '';
}

// Update the modal event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Add hidden.bs.modal event listener to all modals
  const modals = ['contextModal', 'textToLatexModal', 'shareModal'];
  
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('hidden.bs.modal', function() {
        cleanupModal(modalId);
      });
    }
  });
});
document.getElementById('share-preview').addEventListener('click', async () => {
  document.getElementById('shareModal').addEventListener('hidden.bs.modal', function () {
    cleanupModal('shareModal');
    this.remove();
  });
});

document.getElementById('save-as-template').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('saveTemplateModal'));
    modal.show();
});

document.getElementById('confirmSaveTemplate').addEventListener('click', async function() {
    const title = document.getElementById('templateTitle').value.trim();
    const category = document.getElementById('templateCategory').value;
    const content = editor.getValue();

    if (!title) {
        showNotification('Please enter a template title');
        return;
    }

    try {
        const response = await fetch('/create-template', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title,
                content,
                category,
                username: '{{user.username}}'
            })
        });

        const data = await response.json();
        
        if (data.success) {
            showNotification('Template saved successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('saveTemplateModal'));
            modal.hide();
        } else {
            throw new Error(data.error || 'Failed to save template');
        }
    } catch (error) {
        console.error('Error saving template:', error);
        showNotification('Error saving template: ' + error.message);
    }
});

// Helper function to show notifications
function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.add('hide');
        setTimeout(() => {
            notification.classList.remove('show', 'hide');
        }, 500);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    // Check if we're loading a note from sessionStorage
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('loadNote') === 'true') {
        const noteContent = sessionStorage.getItem('note_content');
        const noteTitle = sessionStorage.getItem('note_title');
        
        if (noteContent && noteTitle) {
            // Set the editor content and title
            editor.setValue(unescapeLatex(noteContent));
            document.getElementById('note-title').value = unescapeLatex(noteTitle);
            
            // Render the preview
            renderLaTeX();
            
            // Clear the sessionStorage
            sessionStorage.removeItem('note_content');
            sessionStorage.removeItem('note_title');
            sessionStorage.removeItem('note_id');
        }
    }
});
</script>

